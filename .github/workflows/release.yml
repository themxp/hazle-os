name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build Docker image
      run: docker build -t hazle-os-builder .
      
    - name: Clean build
      run: docker run --rm -v ${{ github.workspace }}:/workspace hazle-os-builder make clean
      
    - name: Build Hazle OS
      run: docker run --rm -v ${{ github.workspace }}:/workspace hazle-os-builder make
      
    - name: Verify build
      run: |
        echo "Checking build artifacts..."
        ls -lh hazle-os.iso
        ls -lh build/hazle.bin
        
        echo "ISO file size: $(du -h hazle-os.iso | cut -f1)"
        echo "Kernel size: $(du -h build/hazle.bin | cut -f1)"
    
    - name: Rename ISO for release
      run: |
        cp hazle-os.iso hazle-os-${{ inputs.version }}.iso
        echo "Created: hazle-os-${{ inputs.version }}.iso"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ inputs.version }}
        name: Hazle OS ${{ inputs.version }}
        body: |
          ## Hazle OS ${{ inputs.version }}
          
          A simple educational operating system built from scratch.
          
          ### What's New
          - Built automatically via GitHub Actions
          - Clean build from source
          
          ### How to Run
          
          **QEMU (recommended):**
          ```bash
          qemu-system-i386 -cdrom hazle-os-${{ inputs.version }}.iso -m 128M
          ```
          
          Or use `qemu-system-x86_64` if you don't have i386 version.
          
          **VirtualBox:**
          1. Create new VM (Linux, Other 32-bit)
          2. Attach ISO to optical drive
          3. Boot
          
          ### Commands
          Type `help` to see all available commands.
          
          ---
          **Educational purposes only. Not for production use.**
        files: |
          hazle-os-${{ inputs.version }}.iso
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hazle-os-release-${{ inputs.version }}
        path: |
          hazle-os-${{ inputs.version }}.iso
          build/hazle.bin
        retention-days: 90

